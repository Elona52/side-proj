<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê°€ê²© ì•Œë¦¼ - ë‚˜ì˜ê²½ë§¤</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&display=swap" rel="stylesheet">
    
    <!-- Court Auction CSS -->
    <link rel="stylesheet" th:href="@{/css/auction.css}">
    <link rel="stylesheet" th:href="@{/css/kamco.css}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/style.css}">
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <style>
        :root {
            --court-blue: #004098;
            --court-navy: #002855;
            --border-gray: #ddd;
            --bg-light: #f5f5f5;
            --text-dark: #333;
            --text-gray: #777;
        }

        /* * { box-sizing: border-box; } - auction.cssì—ì„œ ê´€ë¦¬ */
        /* html, body ìŠ¤íƒ€ì¼ì€ auction.cssì—ì„œ ê´€ë¦¬ */

        /* ========== ë©”ì¸ ë ˆì´ì•„ì›ƒ ========== */
        .board-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
            display: flex;
            gap: 30px;
        }

        .side-menu {
            width: 250px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 0;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .side-menu-header {
            background: var(--court-blue);
            color: #fff;
            padding: 15px 20px;
            font-size: 16px;
            font-weight: 700;
        }

        .side-menu-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .side-menu-item {
            border-bottom: 1px solid #f0f0f0;
        }

        .side-menu-item a {
            display: block;
            padding: 14px 20px;
            color: var(--text-dark);
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s;
        }

        .side-menu-item a:hover {
            background: #f8f9fa;
            color: var(--court-blue);
            padding-left: 25px;
        }

        .side-menu-item.active a {
            background: var(--court-blue);
            color: #fff;
            font-weight: 700;
        }

        .main-content {
            flex: 1;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 0;
        }

        .breadcrumb {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border-gray);
            font-size: 13px;
            color: var(--text-gray);
        }

        .breadcrumb a {
            color: var(--text-gray);
            text-decoration: none;
        }

        .breadcrumb a:hover {
            color: var(--court-blue);
        }

        .search-summary {
            padding: 20px 25px;
            background: #f8f9fa;
            border-bottom: 1px solid var(--border-gray);
        }

        .search-summary-title {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 10px;
        }

        .search-summary-text {
            font-size: 14px;
            color: var(--text-gray);
        }

        .search-summary-text strong {
            color: var(--court-blue);
            font-weight: 700;
        }

        .note {
            padding: 12px 25px;
            background: #fffbf0;
            border-bottom: 1px solid #ffe082;
            font-size: 13px;
            color: #795548;
        }

        /* ========== ê°€ê²© ì•Œë¦¼ í…Œì´ë¸” ========== */
        .table-container {
            padding: 25px !important;
            width: 100% !important;
            max-width: 100% !important;
        }

        .alert-table {
            width: 100% !important;
            border-collapse: collapse !important;
            font-size: 13px !important;
            table-layout: fixed !important;
        }

        .alert-table thead {
            background: #f8f9fa;
            border-top: 2px solid var(--court-blue);
            border-bottom: 1px solid var(--border-gray);
        }

        .alert-table th {
            padding: 12px 10px;
            text-align: center;
            font-weight: 700;
            color: var(--text-dark);
            font-size: 14px;
        }

        .alert-table tbody tr {
            height: 60px;
        }

        .alert-table tbody td {
            padding: 12px 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
        }

        .alert-table tbody tr:hover {
            background: #f8f9fa;
        }

        .alert-number {
            text-align: center;
            color: var(--text-gray);
            font-weight: 600;
        }

        .alert-item-name {
            text-align: left;
            color: var(--text-dark);
            font-weight: 600;
        }

        .alert-price {
            text-align: right;
            font-weight: 700;
        }

        .price-change {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 8px;
        }

        .price-down {
            color: #dc3545;
        }

        .price-up {
            color: #28a745;
        }

        .price-same {
            color: var(--text-gray);
        }

        .alert-date {
            text-align: center;
            color: var(--text-gray);
            font-size: 12px;
        }

        .alert-status {
            text-align: center;
        }

        .status-sent {
            color: #28a745;
            font-weight: 700;
        }

        .status-pending {
            color: var(--text-gray);
        }

        .no-alerts {
            text-align: center;
            padding: 80px 20px;
            background: #fff;
        }

        .no-alerts-icon {
            font-size: 72px;
            margin-bottom: 20px;
            color: #ddd;
        }

        .no-alerts h3 {
            color: #666;
            margin-bottom: 10px;
        }

        .no-alerts p {
            color: #999;
            margin-bottom: 30px;
        }

        @media (max-width: 768px) {
            .board-container {
                flex-direction: column;
            }
            .side-menu {
                width: 100% !important;
                max-width: 100% !important;
            }
        }
    </style>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>

<!-- =================== í—¤ë” =================== -->
<div th:replace="~{layout/header :: header}"></div>

<!-- ë©”ì¸ ì»¨í…ì¸  -->
<main class="board-container">
    <!-- ì¢Œì¸¡ ë„¤ë¹„ -->
    <aside class="side-menu">
        <div class="side-menu-header">â€¢ ë‚˜ì˜ê²½ë§¤</div>
        <ul class="side-menu-list">
            <li class="side-menu-item">
                <a th:href="@{/myFavorites}">
                    <i class="fas fa-star"></i> ì¦ê²¨ì°¾ê¸°
                </a>
            </li>
            <li class="side-menu-item">
                <a th:href="@{/payment/my-payments}">
                    <i class="fas fa-shopping-cart"></i> êµ¬ë§¤ë‚´ì—­
                </a>
            </li>
            <li class="side-menu-item active">
                <a th:href="@{/price-alerts}">
                    <i class="fas fa-bell"></i> ê°€ê²© ì•Œë¦¼
                </a>
            </li>
        </ul>
    </aside>

    <!-- ì˜¤ë¥¸ìª½ ë©”ì¸ -->
    <section class="main-content">
        <!-- ë¸Œë ˆë“œí¬ëŸ¼ -->
        <div class="breadcrumb">
            <a th:href="@{/main}">â–² HOME</a> &gt;
            <a th:href="@{/price-alerts}">ë‚˜ì˜ê²½ë§¤</a> &gt;
            <span>ê°€ê²© ì•Œë¦¼</span>
        </div>

        <!-- ê²€ìƒ‰ ìš”ì•½ -->
        <div class="search-summary">
            <div class="search-summary-title">ê°€ê²© ì•Œë¦¼ íˆìŠ¤í† ë¦¬</div>
            <div class="search-summary-text">
                ì´ ì•Œë¦¼ <strong id="alertsCount">0ê±´</strong>
            </div>
        </div>

        <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
        <div class="note">
            â€¢ ì¦ê²¨ì°¾ê¸°í•œ ë¬¼ê±´ì˜ ê°€ê²© ë³€ë™ ì•Œë¦¼ ë‚´ì—­ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>

        <!-- ê°€ê²© ì•Œë¦¼ ëª©ë¡ -->
        <div class="table-container">
            <div id="alertsContainer">
                <div class="loading" style="text-align: center; padding: 60px 20px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; color: var(--court-blue); margin-bottom: 15px;"></i>
                    <p style="color: var(--text-gray);">ê°€ê²© ì•Œë¦¼ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </div>
        </div>
    </section>
</main>

<!-- =================== í‘¸í„° =================== -->
<div th:replace="~{layout/footer :: footer}"></div>

<!-- JavaScript -->
<script>
    function loadAlerts() {
        console.log('=== ê°€ê²© ì•Œë¦¼ ëª©ë¡ ë¡œë“œ ì‹œì‘ ===');
        
        if (typeof jQuery === 'undefined') {
            console.error('âŒ jQueryê°€ ì—†ìŠµë‹ˆë‹¤.');
            showNoAlerts('jQueryë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const container = $('#alertsContainer');
        if (!container || container.length === 0) {
            console.error('âŒ alertsContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        $.ajax({
            url: '/api/favorites/alerts/api',
            method: 'GET',
            timeout: 15000,
            dataType: 'json',
            success: function(response) {
                console.log('âœ… AJAX ì„±ê³µ ì‘ë‹µ ë°›ìŒ:', response);
                
                try {
                    if (!response) {
                        console.error('âŒ ì‘ë‹µì´ nullì…ë‹ˆë‹¤.');
                        showNoAlerts('ì„œë²„ ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                    
                    if (response.success === true && response.alerts) {
                        console.log('âœ… ê°€ê²© ì•Œë¦¼ ëª©ë¡ ë°œê²¬:', response.alerts.length, 'ê°œ');
                        displayAlerts(response.alerts);
                        $('#alertsCount').text(response.alerts.length + 'ê±´');
                    } 
                    else if (response.success === false) {
                        console.warn('âš ï¸ ê°€ê²© ì•Œë¦¼ ì¡°íšŒ ì‹¤íŒ¨:', response.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                        showNoAlerts(response.message || 'ê°€ê²© ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    }
                    else if (response.alerts && Array.isArray(response.alerts) && response.alerts.length === 0) {
                        console.log('â„¹ï¸ ê°€ê²© ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.');
                        showNoAlerts();
                    }
                    else {
                        console.error('âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ êµ¬ì¡°:', response);
                        showNoAlerts('ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                } catch (e) {
                    console.error('âŒ ì‘ë‹µ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', e);
                    showNoAlerts('ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            },
            error: function(xhr, status, error) {
                console.error('âŒ AJAX ì˜¤ë¥˜ ë°œìƒ:', status, error);
                const container = $('#alertsContainer');
                if (xhr.status === 401 || xhr.status === 403) {
                    container.html('<div class="no-alerts"><h3>ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</h3><p><a href="/memberLogin">ë¡œê·¸ì¸í•˜ëŸ¬ ê°€ê¸°</a></p></div>');
                } else {
                    showNoAlerts('ê°€ê²© ì•Œë¦¼ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });
    }
    
    function displayAlerts(alerts) {
        console.log('=== displayAlerts í˜¸ì¶œ ===');
        console.log('ì•Œë¦¼ ê°œìˆ˜:', alerts ? alerts.length : 0);
        
        if (typeof jQuery === 'undefined') {
            console.error('âŒ jQueryê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const container = $('#alertsContainer');
        if (!container || container.length === 0) {
            console.error('âŒ alertsContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!alerts || !Array.isArray(alerts) || alerts.length === 0) {
            console.log('â„¹ï¸ ê°€ê²© ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤.');
            showNoAlerts();
            return;
        }
        
        let html = '<table class="alert-table">';
        html += '<thead>';
        html += '<tr>';
        html += '<th style="width: 8%;">ë²ˆí˜¸</th>';
        html += '<th style="width: 30%;">ë¬¼ê±´ëª…</th>';
        html += '<th style="width: 20%;">ì´ì „ ê°€ê²©</th>';
        html += '<th style="width: 20%;">ë³€ë™ ê°€ê²©</th>';
        html += '<th style="width: 12%;">ì•Œë¦¼ ìƒíƒœ</th>';
        html += '<th style="width: 10%;">ì•Œë¦¼ ì¼ì‹œ</th>';
        html += '</tr>';
        html += '</thead>';
        html += '<tbody>';
        
        alerts.forEach(function(alert, index) {
            const previousPrice = alert.previousPrice || 0;
            const newPrice = alert.newPrice || 0;
            const priceDiff = newPrice - previousPrice;
            const priceChangeClass = priceDiff < 0 ? 'price-down' : (priceDiff > 0 ? 'price-up' : 'price-same');
            const priceChangeIcon = priceDiff < 0 ? 'â†“' : (priceDiff > 0 ? 'â†‘' : 'â†’');
            const priceChangeText = priceDiff < 0 ? 'í•˜ë½' : (priceDiff > 0 ? 'ìƒìŠ¹' : 'ë™ì¼');
            
            const sentDate = alert.sentDate ? new Date(alert.sentDate).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            }) : '-';
            
            html += '<tr>';
            html += '<td class="alert-number">' + (alerts.length - index) + '</td>';
            html += '<td class="alert-item-name">' + escapeHtml(alert.itemPlnmNo || 'ì•Œ ìˆ˜ ì—†ìŒ') + '</td>';
            html += '<td class="alert-price">' + formatPrice(previousPrice) + 'ì›</td>';
            html += '<td class="alert-price">';
            html += '<div class="price-change ' + priceChangeClass + '">';
            html += '<span>' + priceChangeIcon + '</span>';
            html += '<span>' + formatPrice(newPrice) + 'ì›</span>';
            html += '<span style="font-size: 11px;">(' + priceChangeText + ')</span>';
            html += '</div>';
            html += '</td>';
            html += '<td class="alert-status">';
            html += '<span class="' + (alert.alertSent ? 'status-sent' : 'status-pending') + '">';
            html += (alert.alertSent ? 'ì „ì†¡ì™„ë£Œ' : 'ëŒ€ê¸°ì¤‘');
            html += '</span>';
            html += '</td>';
            html += '<td class="alert-date">' + sentDate + '</td>';
            html += '</tr>';
        });
        
        html += '</tbody>';
        html += '</table>';
        
        container.html(html);
        console.log('âœ… ê°€ê²© ì•Œë¦¼ í‘œì‹œ ì™„ë£Œ:', alerts.length, 'ê°œ');
    }
    
    function formatPrice(price) {
        if (!price || price === 0) return '0';
        return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }
    
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showNoAlerts(message) {
        const container = $('#alertsContainer');
        if (!container || container.length === 0) {
            console.error('alertsContainerë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const displayMessage = message || 'ê°€ê²© ì•Œë¦¼ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤';
        const html = '<div class="no-alerts">' +
            '<div class="no-alerts-icon">ğŸ””</div>' +
            '<h3>' + displayMessage + '</h3>' +
            (message ? '' : '<p>ì¦ê²¨ì°¾ê¸°í•œ ë¬¼ê±´ì˜ ê°€ê²©ì´ ë³€ë™ë˜ë©´ ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>') +
            '</div>';
        container.html(html);
    }
    
    // DOM ë¡œë“œ ì™„ë£Œ í›„ ì´ˆê¸°í™”
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadAlerts);
    } else {
        if (typeof jQuery !== 'undefined') {
            $(document).ready(loadAlerts);
        } else {
            setTimeout(loadAlerts, 500);
        }
    }
</script>

</body>
</html>

