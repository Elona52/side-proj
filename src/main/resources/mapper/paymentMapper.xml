<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.api.payment.mapper.PaymentMapper">

    <!-- Payment ResultMap -->
    <resultMap id="PaymentResultMap" type="com.api.payment.domain.Payment">
        <id property="id" column="id"/>
        <result property="auctionNo" column="auction_no"/>
        <result property="itemId" column="item_id"/>
        <result property="cltrNo" column="cltr_no"/>
        <result property="memberId" column="member_id"/>
        <result property="impUid" column="imp_uid"/>
        <result property="merchantUid" column="merchant_uid"/>
        <result property="itemName" column="item_name"/>
        <result property="amount" column="amount"/>
        <result property="paidAmount" column="paid_amount"/>
        <result property="paymentMethod" column="payment_method"/>
        <result property="pgProvider" column="pg_provider"/>
        <result property="pgTid" column="pg_tid"/>
        <result property="cardName" column="card_name"/>
        <result property="cardNumber" column="card_number"/>
        <result property="buyerName" column="buyer_name"/>
        <result property="buyerEmail" column="buyer_email"/>
        <result property="buyerTel" column="buyer_tel"/>
        <result property="buyerAddr" column="buyer_addr"/>
        <result property="buyerPostcode" column="buyer_postcode"/>
        <result property="status" column="status"/>
        <result property="paidAt" column="paid_at"/>
        <result property="failedAt" column="failed_at"/>
        <result property="cancelledAt" column="cancelled_at"/>
        <result property="failReason" column="fail_reason"/>
        <result property="cancelReason" column="cancel_reason"/>
        <result property="receiptUrl" column="receipt_url"/>
        <result property="createdDate" column="created_date"/>
        <result property="updatedDate" column="updated_date"/>
    </resultMap>

    <!-- PaymentHistory ResultMap -->
    <resultMap id="PaymentHistoryResultMap" type="com.api.payment.domain.PaymentHistory">
        <id property="id" column="id"/>
        <result property="paymentId" column="payment_id"/>
        <result property="status" column="status"/>
        <result property="action" column="action"/>
        <result property="description" column="description"/>
        <result property="createdDate" column="created_date"/>
    </resultMap>

    <!-- 결제 정보 생성 -->
    <insert id="insertPayment" parameterType="com.api.payment.domain.Payment" 
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO KNPayment (
            <if test="auctionNo != null">auction_no,</if>
            <if test="itemId != null">item_id,</if>
            <if test="cltrNo != null">cltr_no,</if>
            member_id, imp_uid, merchant_uid, item_name, amount, 
            paid_amount, payment_method, pg_provider, pg_tid,
            card_name, card_number, buyer_name, buyer_email, buyer_tel,
            buyer_addr, buyer_postcode, status, paid_at, failed_at,
            cancelled_at, fail_reason, cancel_reason, receipt_url
        ) VALUES (
            <if test="auctionNo != null">#{auctionNo},</if>
            <if test="itemId != null">#{itemId},</if>
            <if test="cltrNo != null">#{cltrNo},</if>
            #{memberId}, #{impUid}, #{merchantUid}, #{itemName}, #{amount},
            #{paidAmount}, #{paymentMethod}, #{pgProvider}, #{pgTid},
            #{cardName}, #{cardNumber}, #{buyerName}, #{buyerEmail}, #{buyerTel},
            #{buyerAddr}, #{buyerPostcode}, #{status}, #{paidAt}, #{failedAt},
            #{cancelledAt}, #{failReason}, #{cancelReason}, #{receiptUrl}
        )
    </insert>

    <!-- 결제 정보 조회 (ID) -->
    <select id="selectPaymentById" resultMap="PaymentResultMap">
        SELECT * FROM KNPayment WHERE id = #{id}
    </select>

    <!-- 결제 정보 조회 (merchant_uid) -->
    <select id="selectPaymentByMerchantUid" resultMap="PaymentResultMap">
        SELECT * FROM KNPayment WHERE merchant_uid = #{merchantUid}
    </select>

    <!-- 결제 정보 조회 (imp_uid) -->
    <select id="selectPaymentByImpUid" resultMap="PaymentResultMap">
        SELECT * FROM KNPayment WHERE imp_uid = #{impUid}
    </select>

    <!-- 결제 정보 조회 (경매 번호) -->
    <select id="selectPaymentByAuctionNo" resultMap="PaymentResultMap">
        SELECT * FROM KNPayment 
        WHERE auction_no = #{auctionNo}
        ORDER BY created_date DESC
        LIMIT 1
    </select>

    <!-- 회원의 결제 내역 조회 -->
    <select id="selectPaymentsByMemberId" resultMap="PaymentResultMap">
        SELECT * FROM KNPayment 
        WHERE member_id = #{memberId}
        ORDER BY created_date DESC
    </select>

    <!-- 회원과 auction/item에 대한 기존 payment 조회 (중복 체크용) -->
    <select id="selectPaymentByMemberAndItem" resultMap="PaymentResultMap">
        SELECT * FROM KNPayment 
        WHERE member_id = #{memberId}
        AND (
            (auction_no = #{auctionNo} AND #{auctionNo} IS NOT NULL)
            OR (item_id = #{itemId} AND #{itemId} IS NOT NULL)
            OR (cltr_no = #{cltrNo} AND #{cltrNo} IS NOT NULL AND cltr_no IS NOT NULL)
        )
        ORDER BY created_date DESC
        LIMIT 1
    </select>

    <!-- 결제 정보 업데이트 -->
    <update id="updatePayment">
        UPDATE KNPayment 
        SET 
            imp_uid = #{impUid},
            paid_amount = #{paidAmount},
            payment_method = #{paymentMethod},
            pg_provider = #{pgProvider},
            pg_tid = #{pgTid},
            card_name = #{cardName},
            card_number = #{cardNumber},
            status = #{status},
            paid_at = #{paidAt},
            failed_at = #{failedAt},
            cancelled_at = #{cancelledAt},
            fail_reason = #{failReason},
            cancel_reason = #{cancelReason},
            receipt_url = #{receiptUrl}
        WHERE id = #{id}
    </update>

    <!-- 결제 상태 업데이트 -->
    <update id="updatePaymentStatus">
        UPDATE KNPayment 
        SET status = #{status}
        WHERE id = #{id}
    </update>

    <!-- 결제 삭제 -->
    <delete id="deletePayment">
        DELETE FROM KNPayment WHERE id = #{id}
    </delete>

    <!-- 결제 히스토리 추가 -->
    <insert id="insertPaymentHistory" parameterType="com.api.payment.domain.PaymentHistory"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO KNPaymentHistory (payment_id, status, action, description)
        VALUES (#{paymentId}, #{status}, #{action}, #{description})
    </insert>

    <!-- 결제 히스토리 조회 -->
    <select id="selectPaymentHistoryByPaymentId" resultMap="PaymentHistoryResultMap">
        SELECT * FROM KNPaymentHistory 
        WHERE payment_id = #{paymentId}
        ORDER BY created_date DESC
    </select>

</mapper>


